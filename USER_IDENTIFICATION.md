# üë§ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Telegram –±–æ—Ç–µ

–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

## üîç **–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã:**

### **1. –í –∫–∞—á–µ—Å—Ç–≤–µ ID –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º?**

**‚ùå –ù–ï–¢!** –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è **—á–∏—Å–ª–æ–≤–æ–π telegram_id**

### **2. –û–±–Ω–æ–≤—è—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º setrating?**

**‚úÖ –î–ê!** –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É telegram_id

---

## üìã **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**

### **–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –±–æ—Ç –æ—Ç Telegram:**

```python
# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É, Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç:
update.effective_user.id = 123456789           # ‚Üê –≠—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ ID
update.effective_user.username = "john_doe"    # ‚Üê –≠—Ç–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
update.effective_user.first_name = "John"      # ‚Üê –¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
update.effective_user.last_name = "Doe"        # ‚Üê –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
```

### **–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**

```sql
CREATE TABLE user_ratings (
    id INTEGER PRIMARY KEY,
    telegram_id INTEGER UNIQUE NOT NULL,  -- ‚Üê –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π ID
    PT_userId VARCHAR(255),                -- ‚Üê –ò–º—è –≤ PlayTomic (–æ—Ç–¥–µ–ª—å–Ω–æ)
    rating INTEGER,                        -- ‚Üê –†–µ–π—Ç–∏–Ω–≥
    created_at DATETIME,
    updated_at DATETIME
);
```

---

## üéØ **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @john_doe (telegram_id: 123456789):**

**1. –ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞:** `/setrating 10`
```sql
INSERT INTO user_ratings (telegram_id, rating, ...) VALUES (123456789, 10, ...);
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å

**2. –í—Ç–æ—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞:** `/setrating 25`
```sql
UPDATE user_ratings SET rating = 25, updated_at = NOW() WHERE telegram_id = 123456789;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å (—Ä–µ–π—Ç–∏–Ω–≥ 10 ‚Üí 25)

**3. –ö–æ–º–∞–Ω–¥–∞:** `/setptid john_playtomic`
```sql
UPDATE user_ratings SET PT_userId = 'john_playtomic' WHERE telegram_id = 123456789;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è PlayTomic ID –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏

---

## üîÑ **–õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**

### **–í app/services/rating_bot.py:**

```python
async def set_rating_command(update, context):
    current_user_id = update.effective_user.id  # ‚Üê –ß–∏—Å–ª–æ–≤–æ–π ID –∏–∑ Telegram
    
    # –í–∞—Ä–∏–∞–Ω—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ–±–µ —Ä–µ–π—Ç–∏–Ω–≥
    if len(args) == 1 and args[0].isdigit():
        target_user_id = current_user_id  # ‚Üê 123456789
        rating_val = int(args[0])         # ‚Üê 25
        
        set_rating(target_user_id, rating_val)  # ‚Üê –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

### **–í —Ñ—É–Ω–∫—Ü–∏–∏ set_rating():**

```python
def set_rating(user_id: int, rating: int):
    ensure_user_exists(user_id)  # ‚Üê –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –Ω–µ—Ç
    conn = get_db_connection()
    try:
        conn.execute(
            "UPDATE user_ratings SET rating = ?, updated_at = ? WHERE telegram_id = ?",
            (rating, datetime.now(), user_id)  # ‚Üê –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ telegram_id
        )
        conn.commit()  # ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª
    finally:
        conn.close()
```

---

## üß™ **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**

–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É:

```
üìä –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–µ–π –≤ user_ratings:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ telegram_id ‚îÇ PT_userId            ‚îÇ rating ‚îÇ updated_at       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 123456789   ‚îÇ john_new_name        ‚îÇ 25     ‚îÇ 2025-09-20 18:57 ‚îÇ ‚Üê –û–±–Ω–æ–≤–ª–µ–Ω–æ!
‚îÇ 555777      ‚îÇ persistent_test_user ‚îÇ 88     ‚îÇ 2025-09-20 18:54 ‚îÇ
‚îÇ 999111      ‚îÇ final_test_user      ‚îÇ 77     ‚îÇ 2025-09-20 18:54 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∏–¥–∏—Ç–µ?** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –∏–º–µ–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ 25 (–±—ã–ª–æ 10).

---

## üîë **–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

### **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **telegram_id** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π ID –æ—Ç Telegram
- ‚úÖ **UNIQUE INDEX** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **INSERT OR IGNORE** —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
- ‚úÖ **UPDATE** –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ telegram_id –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å (–≤—ã–¥–∞–µ—Ç—Å—è Telegram)
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—è–º–∏ –¥—Ä—É–≥–∏—Ö –ø–æ –∏—Ö telegram_id

### **–ì–∏–±–∫–æ—Å—Ç—å:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å–≤–æ–π @username, –Ω–æ telegram_id –æ—Å—Ç–∞–µ—Ç—Å—è
- ‚úÖ PT_userId (PlayTomic) - –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å Telegram
- ‚úÖ –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –∏ PlayTomic ID –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

---

## üì± **–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ Telegram:**

### **–°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å John (telegram_id: 123456789, @john_doe):

1. /setrating 10
   –ë–æ—Ç: "‚úÖ –†–µ–π—Ç–∏–Ω–≥ –≤–∞–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 10"
   –ë–î: –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å (123456789, NULL, 10, ...)

2. /setptid john_player  
   –ë–æ—Ç: "‚úÖ PlayTomic ID –≤–∞–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: john_player"
   –ë–î: –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å (123456789, "john_player", 10, ...)

3. /setrating 25
   –ë–æ—Ç: "‚úÖ –†–µ–π—Ç–∏–Ω–≥ –≤–∞–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 25"  
   –ë–î: –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å (123456789, "john_player", 25, ...)

4. /profile
   –ë–æ—Ç: "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:
         üèÜ –†–µ–π—Ç–∏–Ω–≥: 25
         üéæ PlayTomic ID: john_player"
```

---

## üéØ **–ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã:**

### **1. ID = –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?**
**‚ùå –ù–ï–¢!** 
- **ID = telegram_id** (—á–∏—Å–ª–æ–≤–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789)
- **–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (@john_doe) –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **PlayTomic ID** - –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### **2. –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º setrating?**
**‚úÖ –î–ê!**
- **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å** –ø–æ telegram_id
- **UPDATE** –≤–º–µ—Å—Ç–æ INSERT –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö
- **updated_at** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
- **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** –∑–∞–ø–∏—Å–µ–π

---

## üîß **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ —Ç–∞–∫:**

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
make db

# SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
sqlite3 rating_bot.db "SELECT telegram_id, COUNT(*) FROM user_ratings GROUP BY telegram_id HAVING COUNT(*) > 1;"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ (–Ω–µ—Ç –¥—É–±–ª–µ–π)
```

**üéâ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ!**
